<div class="app-layout">
    <%- include('partials/sidebar', { user: user, activePage: 'dashboard' }) %>

    <section class="conversations-panel">
        <header class="panel-header">
            <h4 class="mb-0">المحادثات</h4>
            <div class="panel-actions">
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#initiateConversationModal" title="بدء محادثة جديدة">
                    <i class="bi bi-send-plus-fill me-1"></i> إرسال تنبيه
                </button>
            </div>
        </header>
        <div class="list-group list-group-flush" id="conv-list">
            </div>
    </section>

    <main class="chat-panel">
        <header class="chat-header">
            <div id="chat-header-content" class="d-flex align-items-center" style="visibility: hidden;">
                <div id="chat-header-avatar" class="avatar"></div>
                <div class="ms-3">
                    <h5 id="chat-header-name" class="mb-0 fw-bold"></h5>
                    <small id="chat-header-phone" class="text-muted"></small>
                </div>
            </div>
            <div class="chat-header-actions d-flex align-items-center">
                <div id="messageSearchContainer" class="input-group d-none me-2 align-items-center">
                    <input type="text" id="messageSearchInput" class="form-control form-control-sm" placeholder="ابحث في الرسائل...">
                    <span id="searchMatchCounter" class="text-muted small ms-2"></span>
                    <button id="searchPrevBtn" class="btn btn-sm btn-icon" type="button" title="السابق"><i class="bi bi-chevron-up"></i></button>
                    <button id="searchNextBtn" class="btn btn-sm btn-icon" type="button" title="التالي"><i class="bi bi-chevron-down"></i></button>
                    <button id="closeSearchBtn" class="btn btn-sm btn-icon" type="button" title="إغلاق"><i class="bi bi-x-lg"></i></button>
                </div>
                <i id="searchIcon" class="bi bi-search btn-icon" title="بحث في المحادثة"></i> 
                <div class="chat-header-actions dropdown">
                    <i class="bi bi-three-dots btn-icon" data-bs-toggle="dropdown" aria-expanded="false" title="خيارات"></i>
                    <ul class="dropdown-menu dropdown-menu-end"> 
                        <li><a class="dropdown-item status-change-item" href="#" data-status="new">جديدة</a></li>
                        <li><a class="dropdown-item status-change-item" href="#" data-status="in_progress">قيد التنفيذ</a></li>
                        <li><a class="dropdown-item status-change-item" href="#" data-status="resolved">تم حلها</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="notesBtn" data-bs-toggle="modal" data-bs-target="#notesModal">الملاحظات</a></li>
                    </ul> 
                </div>
            </div>
        </header>
        <div class="messages-area">
            <div class="placeholder">
                <h4>اختر محادثة لعرض الرسائل</h4>
            </div>
        </div>
        <button id="scrollToBottomBtn" class="btn btn-primary rounded-circle shadow" title="النزول للأسفل">
            <i class="bi bi-arrow-down"></i>
        </button>
        <footer class="reply-area">
            <form id="replyForm" class="d-none">
                <div class="input-group">
                    <input type="file" id="mediaUpload" style="display:none;">
                    <button class="btn btn-light" type="button" id="attachBtn"><i class="bi bi-paperclip"></i></button>
                    <textarea id="replyMessage" class="form-control" placeholder="اكتب رسالتك هنا..." rows="1" style="resize: none;"></textarea>
                    <button type="submit" class="btn btn-primary" id="replyButton"><i class="bi bi-send-fill"></i></button>
                </div>
            </form>
        </footer>
    </main>
</div>

<div class="modal fade" id="initiateConversationModal" tabindex="-1" aria-labelledby="initiateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="initiateModalLabel">إرسال تنبيه</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="initiateConversationForm">
                    <div class="mb-3">
                        <label for="customerNumbersInput" class="form-label">أرقام هواتف العملاء</label>
                        <input id="customerNumbersInput" class="form-control" placeholder="اكتب رقمًا واضغط Enter، أو الصق قائمة أرقام">
                        <div class="form-text">سيتم التحقق من الأرقام تلقائيًا.</div>
                    </div>
                    <div class="mb-3">
                        <label for="initiationTemplate" class="form-label">اختر قالب الرسالة</label>
                        <select class="form-select" id="initiationTemplate" required>
                            <option value="" selected disabled>جاري تحميل القوالب...</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                <button type="submit" form="initiateConversationForm" class="btn btn-primary" id="sendInitiationBtn">إرسال</button>
            </div>
        </div>
    </div>
</div>

<%- include('partials/modals') %>

<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />
